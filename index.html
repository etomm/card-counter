<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conta Carte – Multi Deck</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b5" />
  <style>
    :root{--bg:#0a0f0a;--fg:#e9f5ee;--muted:#9fb9ad;--accent:#0b5}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--fg);}
    header{position:sticky;top:0;background:#0d1410;border-bottom:1px solid #143;padding:.5rem .75rem;z-index:3}
    h1{font-size:1.05rem;margin:.2rem 0}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.35rem 0}
    button{background:#132; color:var(--fg); border:1px solid #264; padding:.45rem .7rem; border-radius:.5rem; cursor:pointer}
    button.primary{background:var(--accent);border-color:#0a4;color:#021}
    select{background:#0e1410;color:var(--fg);border:1px solid #264;border-radius:.4rem;padding:.4rem .6rem}
    #grid{padding:.5rem; display:grid; gap:.5rem; align-items:stretch; justify-items:stretch; justify-content:start}
    .cell{width:100%; height:100%;}
    .card{width:100%; height:100%; border-radius:.4rem; border:1px solid #2a2f2a; display:flex; align-items:center; justify-content:center; background:#0e1510; position:relative; overflow:hidden; cursor:pointer; transition:transform .05s}
    .card:active{transform:scale(.98)}
    .card img{width:100%; height:100%; object-fit:contain; padding:10px; display:block; opacity:.98; filter:drop-shadow(0 0 .2rem #000a)}
    .card.removed{opacity:.22; filter:grayscale(.9) brightness(.7)}
    .placeholder{width:100%; height:100%; border-radius:.4rem; border:1px dashed #263; background:transparent; pointer-events:none; opacity:.18}
    .badge{position:absolute; inset:auto .35rem .35rem auto; background:#0009; color:#fff; font-size:.75rem; padding:.12rem .36rem; border-radius:.35rem}
    .legend{display:flex;gap:1rem; padding:.2rem .75rem; color:var(--muted); font-size:.95rem; align-items:center; flex-wrap:wrap}
    .status{padding:.4rem .75rem; color:var(--muted)}
    .grid-wrap{width:100vw; max-width:none; margin:0; height:calc(100vh - 140px)}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h1>Conta Carte – Multi Deck</h1>
    <div class="row">
      <label>Deck:</label>
      <select id="deckSelect" aria-label="Seleziona mazzo">
        <option value="poker52">Poker 52 (francese)</option>
        <option value="french40">Francese 40 (A,2–7,J,Q,K)</option>
        <option value="piquet32">Piquet/Skat 32 (7–A)</option>
        <option value="euchre24">Euchre 24 (9–A)</option>
        <option value="napo40">Napoletane 40 (bastoni, coppe, denari, spade)</option>
      </select>
      <button id="saveDeck">Salva</button>
    </div>
    <div class="toolbar">
      <button class="primary" id="reset">Reset</button>
      <button id="inverti">Inverti selezione</button>
      <button id="soloVive">Mostra solo vive</button>
      <button id="soloMorte">Mostra solo morte</button>
      <button id="tutte">Mostra tutte</button>
      <button id="mode13x4">13×4</button>
      <button id="mode4x13">4×13</button>
      <button id="modeAuto">Auto</button>
    </div>
    <div class="legend"> 
      <span>Vive: <strong id="count-live">52</strong></span>
      <span>Morte: <strong id="count-dead">0</strong></span>
      <span id="layout-info"></span>
    </div>
  </header>
  <div class="grid-wrap" id="gridWrap">
    <div id="grid" aria-label="Mazzo responsive"></div>
    <div class="status" id="status"></div>
  </div>
  <script>
  // Deck definitions
  const DECKS = {
    poker52: {
      id:'poker52', name:'Poker 52', type:'french',
      suits:[{id:'S',name:'picche'},{id:'H',name:'cuori'},{id:'D',name:'quadri'},{id:'C',name:'fiori'}],
      ranks:['A','K','Q','J','10','9','8','7','6','5','4','3','2']
    },
    french40: {
      id:'french40', name:'Francese 40', type:'french',
      suits:[{id:'S',name:'picche'},{id:'H',name:'cuori'},{id:'D',name:'quadri'},{id:'C',name:'fiori'}],
      ranks:['A','K','Q','J','7','6','5','4','3','2']
    },
    piquet32: {
      id:'piquet32', name:'Piquet/Skat 32', type:'french',
      suits:[{id:'S',name:'picche'},{id:'H',name:'cuori'},{id:'D',name:'quadri'},{id:'C',name:'fiori'}],
      ranks:['A','K','Q','J','10','9','8','7']
    },
    euchre24: {
      id:'euchre24', name:'Euchre 24', type:'french',
      suits:[{id:'S',name:'picche'},{id:'H',name:'cuori'},{id:'D',name:'quadri'},{id:'C',name:'fiori'}],
      ranks:['A','K','Q','J','10','9']
    },
    napo40: {
      id:'napo40', name:'Napoletane 40', type:'latin',
      suits:[{id:'B',name:'bastoni'},{id:'C',name:'coppe'},{id:'D',name:'denari'},{id:'S',name:'spade'}],
      ranks:['A','2','3','4','5','6','7','F','C','R'] // F=fante, C=cavallo, R=re
    }
  };

  let activeDeck = DECKS.poker52;

  const grid = document.getElementById('grid');
  const gridWrap = document.getElementById('gridWrap');
  const header = document.querySelector('header');
  const deckSelect = document.getElementById('deckSelect');

  // Load saved deck
  const savedDeckId = localStorage.getItem('deck-id');
  if(savedDeckId && DECKS[savedDeckId]){ activeDeck = DECKS[savedDeckId]; deckSelect.value = savedDeckId; }

  // State
  const stateKeyBase = 'multi-deck-state-';
  function stateKey(){ return stateKeyBase + activeDeck.id; }
  let removed = new Set(JSON.parse(localStorage.getItem(stateKey()) || '[]'));
  let mode = 'auto'; // 'auto' | '13x4' | '4x13'
  let filterMode = 'live'; // 'all' | 'live' | 'dead'

  function suitGlyphFrench(s){ switch(s){ case 'S': return '♠'; case 'H': return '♥'; case 'D': return '♦'; case 'C': return '♣'; } }
  function isRedFrench(s){ return (s==='H'||s==='D'); }
  function inkFrench(s){ return isRedFrench(s) ? '#e44747' : '#eaf3ea'; }

  // Latin suit drawing helpers
  function latinShape(s, cx, cy, size, fill){
    // return SVG path elements strings for latin suits
    if(s==='D'){ // denari: circle
      return `<circle cx='${cx}' cy='${cy}' r='${size*0.5}' fill='${fill}' />`;
    }
    if(s==='C'){ // coppe: cup
      const w = size, h = size*0.7;
      return `
        <path d='M ${cx-w*0.45} ${cy} Q ${cx} ${cy-h} ${cx+w*0.45} ${cy} Z' fill='${fill}' />
        <rect x='${cx-w*0.12}' y='${cy}' width='${w*0.24}' height='${h*0.35}' rx='${w*0.06}' fill='${fill}' />
        <rect x='${cx-w*0.35}' y='${cy+h*0.35}' width='${w*0.7}' height='${h*0.12}' rx='${w*0.06}' fill='${fill}' />`;
    }
    if(s==='S'){ // spade (swords): stylized sword
      const w=size*0.18, h=size*0.9;
      return `
        <rect x='${cx-w/2}' y='${cy-h/2}' width='${w}' height='${h}' rx='${w*0.3}' fill='${fill}' />
        <polygon points='${cx-w} ${cy-h*0.45}, ${cx} ${cy-h*0.62}, ${cx+w} ${cy-h*0.45}' fill='${fill}' />
        <rect x='${cx-w*1.8}' y='${cy+h*0.3}' width='${w*3.6}' height='${w*0.6}' rx='${w*0.3}' fill='${fill}' />`;
    }
    if(s==='B'){ // bastoni: club stick
      const w=size*0.22, h=size*0.85;
      return `
        <rect x='${cx-w/2}' y='${cy-h/2}' width='${w}' height='${h}' rx='${w*0.5}' fill='${fill}' />
        <circle cx='${cx}' cy='${cy-h*0.45}' r='${w*0.85}' fill='${fill}' />`;
    }
    return '';
  }

  function cornerIndex(rank, s){
    // Determine deck type and draw accordingly
    if(activeDeck.type==='french'){
      const c = inkFrench(s);
      const sg = suitGlyphFrench(s);
      return `
        <g fill='${c}' font-family='-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif' font-weight='700'>
          <text x='54' y='116' font-size='82'>${rank}</text>
          <text x='54' y='186' font-size='82'>${sg}</text>
          <g transform='rotate(180 315 440)'>
            <text x='54' y='116' font-size='82'>${rank}</text>
            <text x='54' y='186' font-size='82'>${sg}</text>
          </g>
        </g>`;
    } else {
      // latin: draw rank text and small shape
      const fill = '#eaf3ea';
      return `
        <g fill='${fill}' font-family='-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif' font-weight='700'>
          <text x='54' y='116' font-size='82'>${rank}</text>
          <g>${latinShape(s, 54, 186, 60, fill)}</g>
          <g transform='rotate(180 315 440)'>
            <text x='54' y='116' font-size='82'>${rank}</text>
            <g>${latinShape(s, 54, 186, 60, fill)}</g>
          </g>
        </g>`;
    }
  }

  function pipsFrench(rank, suit){
    // Smaller pip size per latest feedback
    const c = inkFrench(suit);
    const X = {L:150, CL:240, C:315, CR:390, R:480};
    const Y = {T:160, UT:270, M:440, DB:610, B:720};
    let content = `<g fill='${c}' font-family='-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif' font-weight='700'>`;
    const num = (rank==='A')?1 : (rank==='K'||rank==='Q'||rank==='J'?null : (rank==='10'?10:parseInt(rank)));
    const glyph = suitGlyphFrench(suit);
    function pip(x,y,rotate){ const rot = rotate ? ` transform='rotate(180 ${x} ${y})'` : ''; return `<text x='${x}' y='${y}' font-size='96' text-anchor='middle' dominant-baseline='middle'${rot}>${glyph}</text>`; }
    if(rank==='A'){
      content += `<text x='315' y='440' font-size='210' text-anchor='middle' dominant-baseline='middle'>${glyph}</text>`;
    } else if(num){
      switch(num){
        case 2: content += pip(X.C, Y.T, false)+pip(X.C, Y.B, true); break;
        case 3: content += pip(X.C,Y.T,false)+pip(X.C,Y.M,false)+pip(X.C,Y.B,true); break;
        case 4: content += pip(X.L,Y.T,false)+pip(X.R,Y.T,false)+pip(X.L,Y.B,true)+pip(X.R,Y.B,true); break;
        case 5: content += pip(X.L,Y.T,false)+pip(X.R,Y.T,false)+pip(X.C,Y.M,false)+pip(X.L,Y.B,true)+pip(X.R,Y.B,true); break;
        case 6: content += pip(X.L,Y.T,false)+pip(X.R,Y.T,false)+pip(X.L,Y.M,false)+pip(X.R,Y.M,false)+pip(X.L,Y.B,true)+pip(X.R,Y.B,true); break;
        case 7: content += pip(X.C,Y.T,false)+pip(X.L,Y.UT,false)+pip(X.R,Y.UT,false)+pip(X.L,Y.M,false)+pip(X.R,Y.M,false)+pip(X.L,Y.B,true)+pip(X.R,Y.B,true); break;
        case 8: content += pip(X.C,Y.T,false)+pip(X.L,Y.UT,false)+pip(X.R,Y.UT,false)+pip(X.L,Y.M,false)+pip(X.R,Y.M,false)+pip(X.L,Y.DB,true)+pip(X.R,Y.DB,true)+pip(X.C,Y.B,true); break;
        case 9: content += pip(X.C,Y.M,false)+pip(X.C,Y.T,false)+pip(X.C,Y.B,true)+pip(X.L,Y.UT,false)+pip(X.R,Y.UT,false)+pip(X.L,Y.DB,true)+pip(X.R,Y.DB,true)+pip(X.L,Y.M,false)+pip(X.R,Y.M,false); break;
        case 10: content += pip(X.L,Y.T,false)+pip(X.R,Y.T,false)+pip(X.L,Y.UT,false)+pip(X.R,Y.UT,false)+pip(X.L,Y.M,false)+pip(X.R,Y.M,false)+pip(X.L,Y.DB,true)+pip(X.R,Y.DB,true)+pip(X.L,Y.B,true)+pip(X.R,Y.B,true); break;
      }
    } else {
      // Faces: show large rank+glyph
      content += `<text x='315' y='420' font-size='240' text-anchor='middle' dominant-baseline='middle' opacity='0.95'>${rank}</text>`;
      content += `<text x='315' y='620' font-size='140' text-anchor='middle' dominant-baseline='middle' opacity='0.9'>${glyph}</text>`;
    }
    content += '</g>';
    return content;
  }

  function centerLatin(suit){
    const fill = '#eaf3ea';
    return `<g>${latinShape(suit, 315, 440, 260, fill)}</g>`;
  }

  function cardSVG(rank, suit){
    const stroke = (activeDeck.type==='french' && isRedFrench(suit)) ? '#a44' : '#2a3';
    const center = (activeDeck.type==='french') ? pipsFrench(rank, suit) : centerLatin(suit);
    return `data:image/svg+xml;utf8,`+encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 630 880' preserveAspectRatio='xMidYMid meet'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#0f1a12'/><stop offset='1' stop-color='#0a120c'/></linearGradient></defs>
        <rect x='8' y='8' width='614' height='864' rx='36' ry='36' fill='url(#g)' stroke='${stroke}' stroke-width='8'/>
        ${cornerIndex(rank, suit)}
        ${center}
      </svg>`);
  }

  function deckList(){
    const list = [];
    for(const r of activeDeck.ranks){ for(const s of activeDeck.suits){ list.push({r,s}); } }
    return list;
  }

  function cardId(obj){ return obj.r + obj.s.id; }

  function cardMatchesFilter(id){ const isDead = removed.has(id); if(filterMode==='all') return true; if(filterMode==='live') return !isDead; if(filterMode==='dead') return isDead; }

  function countsByAxes(){
    const countsSuit = {}; const countsRank={};
    for(const s of activeDeck.suits){ countsSuit[s.id]=0; }
    for(const r of activeDeck.ranks){ countsRank[r]=0; }
    for(const r of activeDeck.ranks){ for(const s of activeDeck.suits){ const id = r + s.id; if(cardMatchesFilter(id)) { countsSuit[s.id]++; countsRank[r]++; } } }
    return {countsSuit, countsRank};
  }

  function axes(){
    const {countsSuit, countsRank} = countsByAxes();
    const suitsAxis = (filterMode==='all' ? activeDeck.suits : activeDeck.suits.filter(s=> countsSuit[s.id]>0));
    const ranksAxis = (filterMode==='all' ? activeDeck.ranks : activeDeck.ranks.filter(r=> countsRank[r]>0));
    return {suitsAxis, ranksAxis};
  }

  function render(){
    grid.innerHTML = '';
    const {suitsAxis, ranksAxis} = axes();
    const colsByRank = currentConfig().colsBy === 'rank';

    if(colsByRank){
      for(const s of suitsAxis){ for(const r of ranksAxis){ const id = r + s.id; const wrapper = document.createElement('div'); wrapper.className = 'cell'; if(cardMatchesFilter(id)){ const el = document.createElement('button'); el.className = 'card'; el.type='button'; const img = document.createElement('img'); img.alt = `${r} di ${s.name}`; img.loading='lazy'; img.decoding='async'; img.src = cardSVG(r, s.id); el.appendChild(img); if(removed.has(id)) el.classList.add('removed'); const badge=document.createElement('span'); badge.className='badge'; badge.textContent = removed.has(id)?'morta':'viva'; el.appendChild(badge); el.addEventListener('click', ()=>{ if(removed.has(id)) removed.delete(id); else removed.add(id); save(); updateCounts(); render(); layout(); }); wrapper.appendChild(el);} else { const ph=document.createElement('div'); ph.className='placeholder'; wrapper.appendChild(ph);} grid.appendChild(wrapper);} }
    } else {
      for(const r of ranksAxis){ for(const s of suitsAxis){ const id = r + s.id; const wrapper = document.createElement('div'); wrapper.className = 'cell'; if(cardMatchesFilter(id)){ const el = document.createElement('button'); el.className='card'; el.type='button'; const img=document.createElement('img'); img.alt=`${r} di ${s.name}`; img.loading='lazy'; img.decoding='async'; img.src=cardSVG(r, s.id); el.appendChild(img); if(removed.has(id)) el.classList.add('removed'); const badge=document.createElement('span'); badge.className='badge'; badge.textContent = removed.has(id)?'morta':'viva'; el.appendChild(badge); el.addEventListener('click', ()=>{ if(removed.has(id)) removed.delete(id); else removed.add(id); save(); updateCounts(); render(); layout(); }); wrapper.appendChild(el);} else { const ph=document.createElement('div'); ph.className='placeholder'; wrapper.appendChild(ph);} grid.appendChild(wrapper);} }
    }
  }

  function currentConfig(){ if(mode === '13x4') return {colsBy:'rank'}; if(mode === '4x13') return {colsBy:'suit'}; const aspect = window.innerWidth / window.innerHeight; return aspect >= 1.2 ? {colsBy:'rank'} : {colsBy:'suit'}; }

  function save(){ localStorage.setItem(stateKey(), JSON.stringify([...removed])); }
  function updateCounts(){ const total = activeDeck.ranks.length * activeDeck.suits.length; const dead = removed.size; const live = total - dead; document.getElementById('count-live').textContent = String(live); document.getElementById('count-dead').textContent = String(dead); }

  function layout(){
    const vw = window.innerWidth; const vh = window.innerHeight; const headerH = header.getBoundingClientRect().height; const availH = Math.max(200, vh - headerH - 8); gridWrap.style.height = availH + 'px';
    const {suitsAxis, ranksAxis} = axes(); const cfg = currentConfig();
    const colsTarget = cfg.colsBy==='rank' ? Math.max(1, ranksAxis.length) : Math.max(1, suitsAxis.length);
    const rowsTarget = cfg.colsBy==='rank' ? Math.max(1, suitsAxis.length) : Math.max(1, ranksAxis.length);
    const gap = 8; const paddingX = 16; const cardW_fromW = Math.floor((vw - paddingX - gap*(colsTarget-1)) / colsTarget); const cardH_fromH = Math.floor((availH - gap*(rowsTarget-1)) / rowsTarget); const cardW_fromH = Math.floor(cardH_fromH * 63 / 88);
    let cardW; if(cfg.colsBy==='suit'){ cardW = Math.max(48, cardW_fromW); } else { cardW = Math.max(48, Math.min(cardW_fromW, cardW_fromH)); }
    const cardH = Math.floor(cardW * 88 / 63);
    grid.style.gridTemplateColumns = `repeat(${colsTarget}, ${cardW}px)`; grid.style.gridAutoRows = `${cardH}px`;
    document.getElementById('layout-info').textContent = `${colsTarget}×${rowsTarget} ~ ${cardW}×${cardH}px (${cfg.colsBy==='rank'?'13×4-style':'4×13-style'}) [${activeDeck.name}] [filter:${filterMode}]`;
  }

  // Buttons
  document.getElementById('reset').onclick = ()=>{ removed = new Set(); save(); updateCounts(); render(); layout(); };
  document.getElementById('inverti').onclick = ()=>{ const newSet = new Set(); for(const r of activeDeck.ranks){ for(const s of activeDeck.suits){ const id = r + s.id; if(!removed.has(id)) newSet.add(id); } } removed = newSet; save(); updateCounts(); render(); layout(); };
  document.getElementById('soloVive').onclick = ()=>{ filterMode='live'; render(); layout(); };
  document.getElementById('soloMorte').onclick = ()=>{ filterMode='dead'; render(); layout(); };
  document.getElementById('tutte').onclick = ()=>{ filterMode='all'; render(); layout(); };
  document.getElementById('mode13x4').onclick = ()=>{ mode='13x4'; render(); layout(); };
  document.getElementById('mode4x13').onclick = ()=>{ mode='4x13'; render(); layout(); };
  document.getElementById('modeAuto').onclick = ()=>{ mode='auto'; render(); layout(); };
  document.getElementById('saveDeck').onclick = ()=>{ localStorage.setItem('deck-id', deckSelect.value); };
  deckSelect.addEventListener('change', ()=>{
    activeDeck = DECKS[deckSelect.value];
    removed = new Set(JSON.parse(localStorage.getItem(stateKey()) || '[]'));
    render(); updateCounts(); layout();
  });

  // Init
  render(); updateCounts(); layout(); window.addEventListener('resize', ()=>{ render(); layout(); });

  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js'); }); }
  </script>
</body>
</html>